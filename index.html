<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI-Powered Nutritionist Diet Planner</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts for typography -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" xintegrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <!-- Chart.js for data visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-image: url('https://images.unsplash.com/photo-1498837167922-ddd27525d352?q=80&w=2070&auto=format&fit=crop');
            background-size: cover;
            background-attachment: fixed;
            background-position: center;
        }
        .main-container {
            background-color: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }
        @media print {
            body { -webkit-print-color-adjust: exact; print-color-adjust: exact; background-image: none; }
            .no-print { display: none !important; }
            .printable-area { box-shadow: none !important; margin: 0 !important; padding: 0 !important; max-width: 100% !important; border: none !important; }
        }
        .planner-table th, .planner-table td { border: 1px solid #e5e7eb; padding: 0.75rem; text-align: left; }
        .planner-table th { background-color: #f9fafb; }
        .planner-table td { vertical-align: top; background-color: #fff; transition: background-color 0.2s; }
        .planner-table td.has-recipe:hover { background-color: #eff6ff; cursor: pointer; }
        .input-field { width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem; transition: border-color 0.2s; }
        .input-field:focus { outline: none; border-color: #3b82f6; box-shadow: 0 0 0 1px #3b82f6; }
        #loading-modal, #recipe-modal, #share-modal, #error-modal { background-color: rgba(0, 0, 0, 0.6); }
        .loader { border-top-color: #3498db; -webkit-animation: spinner 1.5s linear infinite; animation: spinner 1.5s linear infinite; }
        @-webkit-keyframes spinner { 0% { -webkit-transform: rotate(0deg); } 100% { -webkit-transform: rotate(360deg); } }
        @keyframes spinner { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .modal-content { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        .water-glass { cursor: pointer; transition: color 0.2s; }
        .water-glass.filled { color: #3b82f6 !important; }
        .calendar-day { min-height: 100px; }
    </style>
</head>
<body class="p-4 sm:p-6">
    <!-- Modals -->
    <div id="loading-modal" class="no-print fixed inset-0 z-50 flex-col items-center justify-center hidden">
        <div class="loader ease-linear rounded-full border-8 border-t-8 border-gray-200 h-24 w-24 mb-4"></div>
        <h2 id="loading-text" class="text-center text-white text-xl font-semibold"></h2>
    </div>
    <div id="error-modal" class="no-print fixed inset-0 z-50 flex items-center justify-center hidden p-4">
        <div class="modal-content bg-white rounded-lg shadow-xl w-full max-w-md">
            <div class="p-6 text-center">
                <div class="text-red-500 text-5xl mb-4"><i class="fas fa-exclamation-circle"></i></div>
                <h2 class="text-2xl font-bold text-gray-800 mb-2">An Error Occurred</h2>
                <p id="error-message" class="text-gray-600 mb-6"></p>
                <button onclick="closeErrorModal()" class="w-full bg-red-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-600 transition-colors">Close</button>
            </div>
        </div>
    </div>
    <div id="recipe-modal" class="no-print fixed inset-0 z-40 flex items-center justify-center hidden p-4">
        <div class="modal-content bg-white rounded-lg shadow-xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 id="recipe-title" class="text-2xl font-bold text-gray-800">Recipe</h2>
                    <button onclick="closeRecipeModal()" class="text-gray-400 hover:text-gray-600 text-3xl">&times;</button>
                </div>
                <div id="recipe-content" class="text-gray-600 space-y-4 prose max-w-none"></div>
            </div>
        </div>
    </div>
    <div id="share-modal" class="no-print fixed inset-0 z-40 flex items-center justify-center hidden p-4">
        <div class="modal-content bg-white rounded-lg shadow-xl w-full max-w-md">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold text-gray-800">Share Your Plan</h2>
                    <button onclick="closeShareModal()" class="text-gray-400 hover:text-gray-600 text-3xl">&times;</button>
                </div>
                <p class="text-gray-600 mb-4">Copy the text below to share a summary of your new meal plan!</p>
                <textarea id="share-text" class="w-full h-48 p-3 border border-gray-300 rounded-lg bg-gray-50" readonly></textarea>
                <button onclick="copyShareText()" class="mt-4 w-full bg-green-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-600 transition-colors">Copy to Clipboard</button>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="printable-area main-container max-w-7xl mx-auto rounded-xl shadow-2xl p-6 sm:p-10 border border-gray-200">
        <!-- Header Section -->
        <div class="flex flex-wrap justify-between items-start mb-6 gap-4">
            <div>
                <h1 class="text-3xl sm:text-4xl font-bold text-gray-800">AI Nutrition Dashboard</h1>
                <p class="text-gray-600 mt-1">Your personalized, intelligent meal planning assistant.</p>
                <div id="auth-container" class="mt-2 text-gray-600">Loading user...</div>
            </div>
            <div class="flex items-center gap-2">
                <button onclick="window.print()" class="no-print bg-gray-500 text-white font-semibold py-2 px-4 rounded-lg shadow hover:bg-gray-600 transition-colors">Print</button>
                <button id="share-plan-btn" class="no-print bg-indigo-500 text-white font-semibold py-2 px-4 rounded-lg shadow hover:bg-indigo-600 transition-colors hidden">Share</button>
                <button id="save-plan-btn" class="no-print bg-green-500 text-white font-semibold py-2 px-4 rounded-lg shadow hover:bg-green-600 transition-colors hidden">Save Plan</button>
            </div>
        </div>

        <!-- User Profile and Goals Section -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-10 border-t border-b border-gray-200 py-6">
            <div>
                <h2 class="text-xl font-semibold text-gray-700 mb-4">Client Profile</h2>
                <div class="grid grid-cols-2 gap-x-6 gap-y-4 text-gray-600">
                    <label class="font-medium">Name:</label> <input id="client-name" type="text" class="input-field" placeholder="e.g., Jane Doe">
                    <label class="font-medium">Age:</label> <input id="client-age" type="number" class="input-field" placeholder="e.g., 32">
                    <label class="font-medium">Height (cm):</label> <input id="client-height" type="number" class="input-field" placeholder="e.g., 165">
                    <label class="font-medium">Weight (kg):</label> <input id="client-weight" type="number" class="input-field" placeholder="e.g., 70">
                    <label class="font-medium">Medical Conditions:</label> <input id="client-conditions" type="text" class="input-field" placeholder="e.g., None">
                    <label class="font-medium">Allergies:</label> <input id="client-allergies" type="text" class="input-field" placeholder="e.g., None">
                    <label class="font-medium">Dietary Preference:</label> <input id="client-preference" type="text" class="input-field" placeholder="e.g., Vegetarian, Ayurvedic">
                </div>
            </div>
            <div>
                <h2 class="text-xl font-semibold text-gray-700 mb-4">Health Goals & Targets</h2>
                <div class="grid grid-cols-2 gap-x-6 gap-y-4 text-gray-600">
                    <label class="font-medium">Primary Goal:</label> <input id="client-goal" type="text" class="input-field" placeholder="e.g., Weight loss">
                    <label class="font-medium">Daily Calorie Target:</label> <input id="client-calories" type="number" class="input-field" placeholder="e.g., 1800">
                    <label class="font-medium">Protein (g):</label> <input id="client-protein" type="number" class="input-field" placeholder="e.g., 90">
                    <label class="font-medium">Carbs (g):</label> <input id="client-carbs" type="number" class="input-field" placeholder="e.g., 150">
                </div>
            </div>
        </div>

        <!-- Daily Trackers Section -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-8 mb-10">
            <div>
                <h2 class="text-xl font-semibold text-gray-700 mb-4">Daily Health Checklist</h2>
                <div class="flex gap-2 mb-3">
                    <input id="todo-input" type="text" class="input-field flex-grow" placeholder="e.g., 30-minute walk">
                    <button id="add-todo-btn" class="bg-blue-500 text-white font-semibold px-4 rounded-lg hover:bg-blue-600 transition-colors">+</button>
                </div>
                <ul id="todo-list" class="space-y-2"></ul>
            </div>
            <div class="p-4 bg-gray-50 rounded-lg">
                <h2 class="text-xl font-semibold text-gray-700 mb-4">Daily Hydration</h2>
                <div id="water-tracker" class="flex flex-wrap items-center gap-2 text-3xl text-gray-300 mt-2"></div>
            </div>
            <div class="p-4 bg-gray-50 rounded-lg">
                <h2 class="text-xl font-semibold text-gray-700 mb-4">Daily Trackers</h2>
                <label for="activity-input" class="font-medium text-gray-600">Physical Activity (minutes):</label>
                <input id="activity-input" type="number" min="0" class="input-field mt-1 mb-4" placeholder="e.g., 30">
                <label for="sleep-input" class="font-medium text-gray-600">Sleep (hours):</label>
                <input id="sleep-input" type="number" step="0.5" min="0" class="input-field mt-1" placeholder="e.g., 7.5">
            </div>
        </div>

        <!-- Meal Planner Section -->
        <div class="mb-10">
            <div class="flex flex-wrap justify-between items-center mb-4 gap-4">
                <h2 class="text-2xl font-bold text-gray-800">Weekly Meal Planner</h2>
                <button id="generate-plan-btn" class="no-print bg-blue-600 text-white font-bold py-3 px-6 rounded-lg shadow hover:bg-blue-700 transition-all duration-300 flex items-center gap-2">
                    <span class="text-2xl">✨</span> Generate Full Meal Plan
                </button>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full border-collapse planner-table">
                    <thead>
                        <tr>
                            <th class="w-1/8"></th>
                            <th class="w-1/8 text-center font-semibold">Monday</th>
                            <th class="w-1/8 text-center font-semibold">Tuesday</th>
                            <th class="w-1/8 text-center font-semibold">Wednesday</th>
                            <th class="w-1/8 text-center font-semibold">Thursday</th>
                            <th class="w-1/8 text-center font-semibold">Friday</th>
                            <th class="w-1/8 text-center font-semibold">Saturday</th>
                            <th class="w-1/8 text-center font-semibold">Sunday</th>
                        </tr>
                    </thead>
                    <tbody id="meal-plan-body"></tbody>
                </table>
            </div>
        </div>

        <!-- Analytics Section -->
        <div class="mb-10 border-t border-gray-200 pt-8">
            <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">Your Health Journey</h2>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div class="p-4 bg-gray-50 rounded-lg">
                    <h3 class="text-xl font-semibold text-gray-700 mb-4">Last 7 Days Analysis</h3>
<!-- CODE CORRECTION: Added a wrapper div with a defined height (h-72) and relative positioning. -->
<!-- This fixes the visual glitch where the chart stretches upon scrolling. -->
<div class="relative aspect-video">
    <canvas id="weeklyAnalysisChart"></canvas>
</div>
                    <div id="weekly-summary-container" class="mt-4">
                        <button id="analyze-week-btn" class="w-full bg-purple-500 text-white font-semibold py-2 px-4 rounded-lg shadow hover:bg-purple-600 transition-colors">Analyze My Week</button>
                        <div id="weekly-summary-content" class="mt-3 p-3 bg-purple-50 rounded-lg text-sm text-gray-700 hidden"></div>
                    </div>
                </div>
                <div class="p-4 bg-gray-50 rounded-lg">
                    <div class="flex justify-between items-center mb-4">
                        <button id="prev-month-btn" class="p-2 rounded-full hover:bg-gray-200"><i class="fas fa-chevron-left"></i></button>
                        <h3 id="month-year-header" class="text-xl font-semibold text-gray-700"></h3>
                        <button id="next-month-btn" class="p-2 rounded-full hover:bg-gray-200"><i class="fas fa-chevron-right"></i></button>
                    </div>
                    <div class="grid grid-cols-7 gap-1 text-center font-medium text-gray-500 mb-2">
                        <div>S</div><div>M</div><div>T</div><div>W</div><div>T</div><div>F</div><div>S</div>
                    </div>
                    <div id="monthly-calendar-grid" class="grid grid-cols-7 gap-1"></div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        // --- Firebase SDK Imports ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signInWithCustomToken, signInAnonymously, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, addDoc, onSnapshot, deleteDoc, query, where, getDocs, writeBatch, documentId } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase Configuration & Initialization ---
        // IMPORTANT: This configuration MUST match your Firebase project.
        const firebaseConfig = typeof __firebase_config !== 'undefined' 
            ? JSON.parse(__firebase_config)
            : {
                 apiKey: "AIzaSyD7pEAqAjb8nULmEql3k9LuF1tzyb6DtcU",
  authDomain: "ai-nutritionist-dashboard.firebaseapp.com",
  projectId: "ai-nutritionist-dashboard",
  storageBucket: "ai-nutritionist-dashboard.firebasestorage.app",
  messagingSenderId: "1070059150082",
  appId: "1:1070059150082:web:81de23eb39c1cb1b9ac01b",
  measurementId: "G-R9VEQHBVCS"
            };
        
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // Initialize Firebase services
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- Global State Variables ---
        let userId = null;
        let currentMealPlan = null;
        let dailyTrackerUnsubscribe = () => {};
        let todoUnsubscribe = () => {};
        let weeklyChart = null;
        let currentCalendarDate = new Date();
        const geminiApiKey = ""; // This will be substituted by the environment.

        // --- UI Element References ---
        const authContainer = document.getElementById('auth-container');
        const generateBtn = document.getElementById('generate-plan-btn');
        const saveBtn = document.getElementById('save-plan-btn');
        const shareBtn = document.getElementById('share-plan-btn');
        const analyzeWeekBtn = document.getElementById('analyze-week-btn');
        const weeklySummaryContent = document.getElementById('weekly-summary-content');
        const loadingModal = document.getElementById('loading-modal');
        const loadingText = document.getElementById('loading-text');
        const errorModal = document.getElementById('error-modal');
        const errorMessage = document.getElementById('error-message');
        const mealPlanBody = document.getElementById('meal-plan-body');
        const recipeModal = document.getElementById('recipe-modal');
        const recipeTitle = document.getElementById('recipe-title');
        const recipeContent = document.getElementById('recipe-content');
        const shareModal = document.getElementById('share-modal');
        const shareText = document.getElementById('share-text');
        const todoInput = document.getElementById('todo-input');
        const addTodoBtn = document.getElementById('add-todo-btn');
        const todoList = document.getElementById('todo-list');
        const waterTrackerContainer = document.getElementById('water-tracker');
        const activityInput = document.getElementById('activity-input');
        const sleepInput = document.getElementById('sleep-input');
        const prevMonthBtn = document.getElementById('prev-month-btn');
        const nextMonthBtn = document.getElementById('next-month-btn');

        const days = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];
        const mealTimes = [
            { key: 'earlyMorning', label: 'Early Morning', time: '(6-7 AM)' },
            { key: 'breakfast', label: 'Breakfast', time: '(8-9 AM)' },
            { key: 'midMorningSnack', label: 'Mid-Morning Snack', time: '(11 AM)' },
            { key: 'lunch', label: 'Lunch', time: '(1-2 PM)' },
            { key: 'eveningSnack', label: 'Evening Snack', time: '(4-5 PM)' },
            { key: 'dinner', label: 'Dinner', time: '(7-8 PM)' },
            { key: 'bedtime', label: 'Bedtime', time: '(Optional)' }
        ];
        const TOTAL_GLASSES = 10;

        // --- Initial Setup on Page Load ---
        document.addEventListener('DOMContentLoaded', () => {
            generateBtn.addEventListener('click', generateMealPlan);
            saveBtn.addEventListener('click', saveCurrentMealPlan);
            shareBtn.addEventListener('click', showShareModal);
            addTodoBtn.addEventListener('click', addTodo);
            todoInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') addTodo(); });
            activityInput.addEventListener('change', updateDailyTracker);
            sleepInput.addEventListener('change', updateDailyTracker);
            prevMonthBtn.addEventListener('click', () => changeMonth(-1));
            nextMonthBtn.addEventListener('click', () => changeMonth(1));
            analyzeWeekBtn.addEventListener('click', generateWeeklySummary);
            populateTableStructure();
            populateWaterTracker();
        });

        // --- Firebase Authentication ---
        onAuthStateChanged(auth, async (user) => {
            // Unsubscribe from previous user's data
            dailyTrackerUnsubscribe();
            todoUnsubscribe();

            if (user) {
                userId = user.uid;
                console.log("User signed in:", userId);
                updateAuthUI(user);
                await loadUserProfile();
                setupRealtimeListeners();
            } else {
                userId = null;
                console.log("No user signed in, attempting session sign-in.");
                updateAuthUI(null);
                try {
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        await signInWithCustomToken(auth, __initial_auth_token);
                    } else {
                        await signInAnonymously(auth);
                    }
                } catch (error) {
                    console.error("Automatic sign-in failed:", error);
                    showError("Could not start a session. Please refresh the page. This may be due to a backend configuration issue.");
                }
            }
        });

        function updateAuthUI(user) {
            if (user && !user.isAnonymous) {
                authContainer.innerHTML = `
                    <div class="flex items-center gap-2">
                        <img src="${user.photoURL || `https://placehold.co/40x40/E2E8F0/4A5568?text=${user.displayName?.[0] || 'U'}`}" class="w-10 h-10 rounded-full" alt="Profile">
                        <div>
                            <p class="font-semibold text-gray-700">${user.displayName || 'Welcome!'}</p>
                            <p class="text-xs text-gray-500">${user.email}</p>
                        </div>
                    </div>`;
            } else {
                authContainer.innerHTML = `<button id="google-signin-btn" class="bg-white text-gray-700 font-semibold py-2 px-4 border border-gray-300 rounded-lg shadow-sm hover:bg-gray-50 flex items-center gap-2">
                        <img src="https://www.google.com/favicon.ico" class="w-5 h-5" alt="Google"> Sign in with Google
                    </button>`;
                document.getElementById('google-signin-btn')?.addEventListener('click', signInWithGoogle);
            }
        }

        async function signInWithGoogle() {
            const provider = new GoogleAuthProvider();
            try {
                await setPersistence(auth, browserLocalPersistence);
                await signInWithPopup(auth, provider);
                console.log("Google sign-in successful");
            } catch (error) {
                console.error("Google Sign-in Error:", error);
                showError("Could not sign in with Google. Please try again.");
            }
        }

        // --- AI-Powered Functions ---
        async function callGeminiAPI(prompt, schema = null) {
                        const apiKey = "AIzaSyDi3lY73B_oFSH96Qca1OukqZfeyD2LIg8";

const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
            
            const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }] };

            if (schema) {
                payload.generationConfig = {
                    responseMimeType: "application/json",
                    responseSchema: schema
                };
            }

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorBody = await response.json();
                    console.error("API Error Body:", errorBody);
                    throw new Error(`API Error: ${errorBody.error?.message || response.statusText}`);
                }

                const result = await response.json();

                if (result.candidates?.[0]?.content?.parts?.[0]) {
                    const text = result.candidates[0].content.parts[0].text;
                    return schema ? JSON.parse(text) : text;
                } else {
                    console.error("Unexpected API response structure:", result);
                    throw new Error("Received an invalid response from the AI.");
                }
            } catch (error) {
                console.error("Gemini API call failed:", error);
                throw error;
            }
        }

        async function generateWeeklySummary() {
            if (!weeklyChart) {
                showError("No weekly data to analyze. Please track your water, activity, or sleep.");
                return;
            }
            showLoading(true, "Analyzing your week...");
            const data = weeklyChart.data;
            const summaryData = {
                labels: data.labels,
                sleep: data.datasets[0].data,
                activity: data.datasets[1].data,
                water: data.datasets[2].data,
            };
            const prompt = `As a friendly and encouraging wellness coach, analyze the following weekly data for a user. Provide a short, easy-to-understand summary (2-3 paragraphs). Identify one positive trend to celebrate and one area for gentle improvement. Do not use markdown.
            Data: ${JSON.stringify(summaryData)}`;
            
            try {
                const summaryText = await callGeminiAPI(prompt);
                weeklySummaryContent.textContent = summaryText;
                weeklySummaryContent.classList.remove('hidden');
            } catch (error) {
                showError(`Failed to generate weekly summary. Details: ${error.message}`);
            } finally {
                showLoading(false);
            }
        }

        // --- Core Application Logic ---
        function populateTableStructure() {
            mealPlanBody.innerHTML = '';
            mealTimes.forEach(meal => {
                const row = document.createElement('tr');
                row.innerHTML = `<th>${meal.label}<br><span class="font-normal text-gray-500">${meal.time}</span></th>
                                 ${days.map(day => `<td id="${day}-${meal.key}"></td>`).join('')}`;
                mealPlanBody.appendChild(row);
            });
        }

        function populateWaterTracker() {
            waterTrackerContainer.innerHTML = '';
            for (let i = 1; i <= TOTAL_GLASSES; i++) {
                const glass = document.createElement('i');
                glass.className = 'fas fa-tint water-glass';
                glass.dataset.index = i;
                glass.addEventListener('click', () => handleWaterClick(i));
                waterTrackerContainer.appendChild(glass);
            }
        }

        function setupRealtimeListeners() {
            if (!userId) return;

            // --- Listener for Daily Trackers ---
            const today = new Date().toISOString().split('T')[0];
            const dailyTrackerRef = doc(db, `artifacts/${appId}/users/${userId}/dailyTrackers`, today);
            dailyTrackerUnsubscribe = onSnapshot(dailyTrackerRef, (docSnap) => {
                const data = docSnap.data() || { water: 0, activity: 0, sleep: 0 };
                updateWaterTrackerUI(data.water);
                if (document.activeElement !== activityInput) activityInput.value = data.activity || '';
                if (document.activeElement !== sleepInput) sleepInput.value = data.sleep || '';
                renderWeeklyAnalysis();
                renderMonthlyCalendar();
            }, (error) => {
                console.error("Firestore listener error (Daily Trackers):", error);
                showError("Failed to load daily tracker data. Please check your connection or Firebase setup.");
            });

            // --- Listener for Todos ---
            const todosRef = collection(db, `artifacts/${appId}/users/${userId}/todos`);
            const todosQuery = query(todosRef);
            todoUnsubscribe = onSnapshot(todosQuery, (snapshot) => {
                const todos = [];
                snapshot.forEach(doc => todos.push({ id: doc.id, ...doc.data() }));
                renderTodoList(todos);
            }, (error) => {
                console.error("Firestore listener error (Todos):", error);
                showError("Failed to load todos.");
            });
        }
        
        function renderTodoList(todos) {
            todoList.innerHTML = '';
            todos.forEach(todo => {
                const li = document.createElement('li');
                li.className = 'flex items-center justify-between bg-gray-100 p-2 rounded-lg';
                li.innerHTML = `<span class="flex-grow mr-2">${todo.text}</span><button data-id="${todo.id}" class="text-red-400 hover:text-red-600 delete-todo-btn text-xl font-bold">&times;</button>`;
                li.querySelector('.delete-todo-btn').addEventListener('click', (e) => {
                    e.stopPropagation();
                    deleteTodo(e.target.dataset.id);
                });
                todoList.appendChild(li);
            });
        }

        async function addTodo() {
            const text = todoInput.value.trim();
            if (text === '') { showError("Please enter a task."); return; }
            if (!userId) { showError("Please sign in to add tasks."); return; }
            todoInput.value = '';
            try {
                const todosCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/todos`);
                await addDoc(todosCollectionRef, {
                    text: text,
                    createdAt: new Date()
                });
            } catch (error) {
                console.error("Error adding todo:", error);
                showError("Failed to add task.");
            }
        }

        async function deleteTodo(id) {
            if (!userId) { showError("Please sign in to delete tasks."); return; }
            try {
                const todoDocRef = doc(db, `artifacts/${appId}/users/${userId}/todos`, id);
                await deleteDoc(todoDocRef);
            } catch (error) {
                console.error("Error deleting todo:", error);
                showError("Failed to delete task.");
            }
        }

        function updateWaterTrackerUI(count) {
            const glasses = waterTrackerContainer.querySelectorAll('.water-glass');
            glasses.forEach((glass, index) => {
                glass.classList.toggle('filled', index < count);
            });
        }

        async function handleWaterClick(count) {
            if (!userId) { showError("Please sign in to track water intake."); return; }
            const today = new Date().toISOString().split('T')[0];
            const dailyTrackerRef = doc(db, `artifacts/${appId}/users/${userId}/dailyTrackers`, today);
            try {
                const docSnap = await getDoc(dailyTrackerRef);
                const currentCount = docSnap.exists() ? docSnap.data().water : 0;
                const newCount = currentCount === count ? 0 : count; // Toggle off if clicked again
                await setDoc(dailyTrackerRef, { water: newCount }, { merge: true });
            } catch (error) {
                console.error("Error updating water:", error);
                showError("Failed to update water intake.");
            }
        }

        async function updateDailyTracker() {
            if (!userId) { showError("Please sign in to track activity and sleep."); return; }
            const activity = parseInt(activityInput.value, 10) || 0;
            const sleep = parseFloat(sleepInput.value) || 0;
            if (activity < 0 || sleep < 0) { showError("Please enter valid values for activity and sleep."); return; }
            const dataToUpdate = { activity, sleep };
            const today = new Date().toISOString().split('T')[0];
            const dailyTrackerRef = doc(db, `artifacts/${appId}/users/${userId}/dailyTrackers`, today);
            try {
                await setDoc(dailyTrackerRef, dataToUpdate, { merge: true });
            } catch (error) {
                console.error("Error updating trackers:", error);
                showError("Failed to update daily trackers.");
            }
        }

        async function renderWeeklyAnalysis() {
            if (!userId) return;
            const ctx = document.getElementById('weeklyAnalysisChart')?.getContext('2d');
            if (!ctx) return;

            const labels = [];
            const waterData = [], activityData = [], sleepData = [];
            const datePromises = [];
            for (let i = 6; i >= 0; i--) {
                const date = new Date();
                date.setDate(new Date().getDate() - i);
                const dateString = date.toISOString().split('T')[0];
                labels.push(date.toLocaleDateString('en-US', { weekday: 'short' }));
                const docRef = doc(db, `artifacts/${appId}/users/${userId}/dailyTrackers`, dateString);
                datePromises.push(getDoc(docRef));
            }

            try {
                const docSnaps = await Promise.all(datePromises);
                docSnaps.forEach(docSnap => {
                    const data = docSnap.data() || {};
                    waterData.push(data.water || 0);
                    activityData.push(data.activity || 0);
                    sleepData.push(data.sleep || 0);
                });

                if (weeklyChart) weeklyChart.destroy();
                
                weeklyChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [
                            { label: 'Sleep (hrs)', data: sleepData, borderColor: 'rgb(167, 139, 250)', backgroundColor: 'rgba(167, 139, 250, 0.1)', fill: true, tension: 0.4 },
                            { label: 'Activity (mins)', data: activityData, borderColor: 'rgb(251, 146, 60)', backgroundColor: 'rgba(251, 146, 60, 0.1)', fill: true, tension: 0.4 },
                            { label: 'Water (glasses)', data: waterData, borderColor: 'rgb(59, 130, 246)', backgroundColor: 'rgba(59, 130, 246, 0.1)', fill: true, tension: 0.4 }
                        ]
                    },
                    options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } } }
                });

            } catch (error) {
                console.error("Error rendering weekly analysis:", error);
                showError("Failed to load weekly analysis data.");
            }
        }

        async function renderMonthlyCalendar() {
            if (!userId) return;
            document.getElementById('month-year-header').textContent = currentCalendarDate.toLocaleString('default', { month: 'long', year: 'numeric' });
            const grid = document.getElementById('monthly-calendar-grid');
            grid.innerHTML = '';
            const year = currentCalendarDate.getFullYear();
            const month = currentCalendarDate.getMonth();
            const firstDayOfMonth = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();

            for (let i = 0; i < firstDayOfMonth; i++) grid.insertAdjacentHTML('beforeend', '<div></div>');
            
            for (let day = 1; day <= daysInMonth; day++) {
                const dateString = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const isToday = new Date().toDateString() === new Date(year, month, day).toDateString();
                const dayEl = document.createElement('div');
                dayEl.className = `calendar-day p-1 border border-gray-200 rounded ${isToday ? 'bg-blue-100' : 'bg-white'}`;
                dayEl.innerHTML = `<div class="font-bold">${day}</div><div id="cal-data-${dateString}" class="text-xs text-left pl-1 space-y-1"></div>`;
                grid.appendChild(dayEl);
            }

            const startDate = `${year}-${String(month + 1).padStart(2, '0')}-01`;
            const endDate = `${year}-${String(month + 1).padStart(2, '0')}-${String(daysInMonth).padStart(2, '0')}`;
            const q = query(
                collection(db, `artifacts/${appId}/users/${userId}/dailyTrackers`),
                where(documentId(), '>=', startDate),
                where(documentId(), '<=', endDate)
            );

            try {
                const querySnapshot = await getDocs(q);
                querySnapshot.forEach(doc => {
                    const data = doc.data();
                    const contentEl = document.getElementById(`cal-data-${doc.id}`);
                    if (contentEl) {
                        contentEl.innerHTML = `
                            ${data.sleep ? `<div><i class="fas fa-moon text-purple-400"></i> ${data.sleep}h</div>` : ''}
                            ${data.activity ? `<div><i class="fas fa-running text-orange-400"></i> ${data.activity}m</div>` : ''}
                            ${data.water ? `<div><i class="fas fa-tint text-blue-400"></i> ${data.water}</div>` : ''}
                        `;
                    }
                });
            } catch (error) {
                console.error("Error rendering monthly calendar:", error);
                // Not showing a modal error here as it can be too intrusive on month change.
            }
        }

        function changeMonth(offset) {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() + offset);
            renderMonthlyCalendar();
        }

        function showLoading(show, text = "Generating Meal Plan...") {
            loadingText.textContent = text;
            loadingModal.style.display = show ? 'flex' : 'none';
        }

        function showError(message) {
            errorMessage.textContent = message;
            errorModal.style.display = 'flex';
        }
        window.closeErrorModal = () => errorModal.style.display = 'none';

        async function generateMealPlan() {
            if (!userId) { showError("Please sign in to generate a meal plan."); return; }
            showLoading(true);
            await saveUserProfile(); // Save latest profile before generating
            const clientDetails = {
                age: document.getElementById('client-age').value,
                height: document.getElementById('client-height').value,
                weight: document.getElementById('client-weight').value,
                conditions: document.getElementById('client-conditions').value,
                allergies: document.getElementById('client-allergies').value,
                preference: document.getElementById('client-preference').value,
                goal: document.getElementById('client-goal').value,
                calories: document.getElementById('client-calories').value,
                protein: document.getElementById('client-protein').value,
                carbs: document.getElementById('client-carbs').value
            };
            if (!clientDetails.age || !clientDetails.height || !clientDetails.weight || !clientDetails.calories) {
                showError("Please fill in all required profile fields (age, height, weight, calories).");
                showLoading(false);
                return;
            }
            const prompt = `You are an expert nutritionist creating a diet plan. Based on the following client details, generate a healthy and balanced 7-day meal plan. The client lives in a dense urban environment like Delhi, India, so consider pollution and lifestyle stress. Include antioxidant-rich and immunity-boosting foods.
            **Crucially, if the dietary preference is 'Ayurvedic' or 'Sattvic', the entire meal plan must strictly follow the principles of that diet.**
            Client Details:
            - Age: ${clientDetails.age}, Height: ${clientDetails.height} cm, Weight: ${clientDetails.weight} kg
            - Primary Health Goal: ${clientDetails.goal}
            - Dietary Preference: ${clientDetails.preference}
            - Known Allergies: ${clientDetails.allergies}
            - Medical Conditions: ${clientDetails.conditions}
            - Target Daily Intake: ~${clientDetails.calories} calories, ${clientDetails.protein}g protein, ${clientDetails.carbs}g carbs.
            Provide a simple, practical meal suggestion for each slot.`;
            const schema = { type: "OBJECT", properties: {}, required: days };
            days.forEach(day => {
                schema.properties[day] = { type: "OBJECT", properties: {}, required: mealTimes.map(mt => mt.key) };
                mealTimes.forEach(meal => { schema.properties[day].properties[meal.key] = { type: "STRING" }; });
            });
            
            try {
                const mealPlan = await callGeminiAPI(prompt, schema);
                populateTableWithPlan(mealPlan);
            } catch (error) {
                // CODE CORRECTION (Line 718): Added specific error message for "blocked" API requests.
                console.error("Full error object:", error);
                let userFriendlyMessage = `Failed to generate the meal plan. Details: ${error.message}`;
                if (error.message && error.message.includes("blocked")) {
                    userFriendlyMessage = "The request to the AI service was blocked. This is likely due to API key restrictions in your Google Cloud project. Please check that the 'Generative Language API' is enabled and that your API key's restrictions allow it.";
                }
                showError(userFriendlyMessage);
            } finally {
                showLoading(false);
            }
        }

        function populateTableWithPlan(plan) {
            currentMealPlan = plan;
            days.forEach(day => {
                mealTimes.forEach(meal => {
                    const cell = document.getElementById(`${day}-${meal.key}`);
                    if (cell && plan[day] && plan[day][meal.key]) {
                        cell.textContent = plan[day][meal.key];
                        cell.classList.add('has-recipe');
                        cell.onclick = () => showRecipeModal(plan[day][meal.key]);
                    } else if (cell) {
                        cell.textContent = '';
                        cell.classList.remove('has-recipe');
                        cell.onclick = null;
                    }
                });
            });
            saveBtn.style.display = 'inline-block';
            shareBtn.style.display = 'inline-block';
        }

        async function generateRecipe(mealName) {
            showLoading(true, "Generating Recipe...");
            const preference = document.getElementById('client-preference').value || 'None';
            const prompt = `You are a helpful cooking assistant. Provide a simple, healthy, and quick recipe for "${mealName}". The recipe should be suitable for a person with these dietary preferences: ${preference}. Format the response as simple HTML with headings (h3 for Ingredients/Instructions) and lists (ul/li). Do not include any markdown formatting like \`\`\`html.`;
            
            try {
                const recipeHtml = await callGeminiAPI(prompt);
                recipeContent.innerHTML = recipeHtml;
            } catch (error) {
                recipeContent.innerHTML = `<p class="text-red-500">Sorry, we couldn't generate a recipe at this time. Details: ${error.message}</p>`;
            } finally {
                showLoading(false);
            }
        }

        function showRecipeModal(mealName) {
            recipeTitle.textContent = `Recipe for ${mealName}`;
            recipeContent.innerHTML = `<p>Click the button to generate a recipe!</p><button onclick="generateRecipe('${mealName.replace(/'/g, "\\'")}')" class="mt-4 w-full bg-blue-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-600 transition-colors">Generate Recipe</button>`;
            recipeModal.style.display = 'flex';
        }
        window.closeRecipeModal = () => recipeModal.style.display = 'none';
        window.generateRecipe = generateRecipe;

        function showShareModal() {
            if (!currentMealPlan) { showError("Please generate a meal plan first."); return; }
            const clientName = document.getElementById('client-name').value || 'User';
            const goal = document.getElementById('client-goal').value || 'Health';
            let summary = `Check out my new AI-generated meal plan for ${clientName}!\n\nMy Goal: ${goal}\n\nHere's a sneak peek:\n`;
            summary += `- Monday Breakfast: ${currentMealPlan.monday.breakfast || 'N/A'}\n`;
            summary += `- Wednesday Lunch: ${currentMealPlan.wednesday.lunch || 'N/A'}\n`;
            summary += `- Friday Dinner: ${currentMealPlan.friday.dinner || 'N/A'}\n\n`;
            summary += `Generated with the AI Nutrition Planner!`;
            shareText.value = summary;
            shareModal.style.display = 'flex';
        }
        window.closeShareModal = () => shareModal.style.display = 'none';
        window.copyShareText = () => {
            shareText.select();
            document.execCommand('copy');
            closeShareModal();
        };

        async function loadUserProfile() {
            if (!userId) return;
            const userDocRef = doc(db, `artifacts/${appId}/users`, userId);
            try {
                const docSnap = await getDoc(userDocRef);
                if (docSnap.exists()) {
                    const profile = docSnap.data().profile;
                    if (profile) {
                        Object.keys(profile).forEach(key => {
                            const element = document.getElementById(key);
                            if (element) element.value = profile[key] || '';
                        });
                    }
                }
            } catch (error) {
                console.error("Error loading user profile:", error);
                showError("Failed to load your saved profile.");
            }
        }

        async function saveUserProfile() {
            if (!userId) return;
            const profileData = {
                'client-name': document.getElementById('client-name').value,
                'client-age': document.getElementById('client-age').value,
                'client-height': document.getElementById('client-height').value,
                'client-weight': document.getElementById('client-weight').value,
                'client-conditions': document.getElementById('client-conditions').value,
                'client-allergies': document.getElementById('client-allergies').value,
                'client-preference': document.getElementById('client-preference').value,
                'client-goal': document.getElementById('client-goal').value,
                'client-calories': document.getElementById('client-calories').value,
                'client-protein': document.getElementById('client-protein').value,
                'client-carbs': document.getElementById('client-carbs').value,
            };
            const userDocRef = doc(db, `artifacts/${appId}/users`, userId);
            try {
                await setDoc(userDocRef, { profile: profileData }, { merge: true });
            } catch (error) {
                console.error("Error saving user profile:", error);
                showError("Failed to save your profile.");
            }
        }

        async function saveCurrentMealPlan() {
            if (!currentMealPlan || !userId) { showError("No active meal plan to save or not signed in."); return; }
            showLoading(true, "Saving Plan...");
            try {
                const plansCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/mealPlans`);
                await addDoc(plansCollectionRef, {
                    createdAt: new Date(),
                    planName: `Meal Plan - ${new Date().toLocaleDateString()}`,
                    planData: JSON.parse(JSON.stringify(currentMealPlan)) // Clean serialization
                });
            } catch (error) {
                console.error("Error saving plan:", error);
                showError("Could not save the plan.");
            } finally {
                showLoading(false);
            }
        }
    </script>
</body>
</html>
